---
title: "Figure1"
author: "Devi Veytia"
date: "2023-12-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Figure description/overview

This figure shows the Distribution of research across OROs and its time evolution

Panel A: Line plot of # articles for each ORO branch and Ocean & climate research by year     
Panel B: Barplot of # articles for each ORO type, filled by % articles in IPCC report. Perhaps also label at the top of the bar the year of the inflexion point of the exponential relationship    

*Key messages:*
1. there is exponential increase in research effort / articles on OROs  
? comparator : total number of articles on climate & Ocean / WoS query)	ðŸ¡ª(Panel a)
 
2. Research effort on OROs is dominated by articles on Renewable energy (50%)  (Panel b). Comparator IPCC ref list â€“ hypothesize there will be very few on renewable energy but much more on NbS

3. Contrasted trends in research effort for the different OROs types (Panel b). 



# Set up

```{r load libraries}
library(dplyr)
library(dbplyr)
library(R.utils)
library(RSQLite)
library(ggplot2)
```


```{r Get the latest version of sqlite database and connect}

sqliteDir <- here::here("data/sqlite-databases")
sqliteFiles <- dir(sqliteDir)
sqliteVersions <- as.numeric(gsub(".sqlite","",substring(sqliteFiles, regexpr("_v", sqliteFiles) + 2)))
latestVersion <- sqliteFiles[which.max(sqliteVersions)]
dbcon <- RSQLite::dbConnect(RSQLite::SQLite(), file.path(sqliteDir, latestVersion), create=FALSE)
```


```{r import common aesthetics}
factor_aes <- readxl::read_excel(here::here("R/factor_aesthetics.xlsx"))

```

# Panel A: Line plot of # articles for each ORO branch and Ocean & climate research by year

For each year, and for each branch, count the number of lower, mean and upper articles relevant for each branch
```{r Sum n articles per oro branch per year}
predRel <- tbl(dbcon, "pred_relevance") 
pred_oro_branch <- tbl(dbcon, "pred_oro_branch")
uniquerefs <- tbl(dbcon, "allrefs")

oro_branch_by_year <- pred_oro_branch %>%
  inner_join(predRel %>% select(analysis_id, relevance_mean), by = "analysis_id")%>%
  filter(0.5 <= relevance_mean) %>%
  inner_join(uniquerefs %>% select(analysis_id, year), by = "analysis_id") %>%
  group_by(year) %>%
  summarise(
    Mitigation_mean = sum(0.5 <= `oro_branch.Mitigation - mean_prediction`),
    Mitigation_lower = sum(0.5 <= `oro_branch.Mitigation - lower_pred`),
    Mitigation_upper = sum(0.5 <= `oro_branch.Mitigation - upper_pred`),
    Nature_mean = sum(0.5 <= `oro_branch.Nature - mean_prediction`),
    Nature_lower = sum(0.5 <= `oro_branch.Nature - lower_pred`),
    Nature_upper = sum(0.5 <= `oro_branch.Nature - upper_pred`),
    Societal_mean = sum(0.5 <= `oro_branch.Societal - mean_prediction`),
    Societal_lower = sum(0.5 <= `oro_branch.Societal - lower_pred`),
    Societal_upper = sum(0.5 <= `oro_branch.Societal - upper_pred`)
  ) %>% 
  collect()

# Melt and reformat so each line is a yearxbranch, and then columns for mean, lower and upper
variables <- c("Mitigation","Nature","Societal")

for(v in 1:length(variables)){
  sub <- oro_branch_by_year[,c(1,grep(variables[v], colnames(oro_branch_by_year)))]
  colnames(sub) <- gsub(paste0(variables[v],"_"),"", colnames(sub))
  # sub <- reshape2::melt(sub, id.vars = "year", variable.name = "prediction_boundary", 
  #                       value.name = "n_articles")
  sub$ORO_branch <- paste(variables[v])
  if(v==1){
    oro_branch_by_year_sums <- sub
  }else{
    oro_branch_by_year_sums <- rbind(oro_branch_by_year_sums, sub)
  }
}


# Factor and format
oro_branch_by_year_sums <- oro_branch_by_year_sums%>%
  na.omit() %>%
  mutate(year = as.Date(paste0(year, "-01-01")),
         ORO_branch = factor(ORO_branch, levels = variables))

varAES <- factor_aes[which(factor_aes$variable == "ORO_branch"),]
varAES <- varAES[order(varAES$order),]
oro_branch_by_year_sums$ORO_branch <- factor(
  oro_branch_by_year_sums$ORO_branch,
  levels = varAES$level, labels = varAES$label
)

summary(oro_branch_by_year_sums)


# use the max year to set the x limits
xmax = max(oro_branch_by_year_sums$year)
xmin = min(oro_branch_by_year_sums$year)
```

```{r get number of articles from citation indexed databases}

## Web of Science
wos_by_year <- read.delim2(
  here::here("data/external/ocean-and-climate-publications/WOS_ocean-and-climate_by-year_2023-11-21.txt"))

wos_by_year <- wos_by_year %>%
  rename(year = Publication.Years, n_articles = Record.Count)%>%
  select(year, n_articles)%>%
  mutate(year = as.Date(paste0(year, "-01-01"))) %>%
  filter(xmin <= year & year <= xmax) %>%
  na.omit()


## Scopus
scopus_by_year <- read.csv(
  here::here("data/external/ocean-and-climate-publications/SCOPUS_ocean-and-climate_by-year_2023-11-21.csv"))

scopus_by_year <- scopus_by_year %>%
  mutate(year = as.Date(paste0(year, "-01-01"))) %>%
  filter(xmin <= year & year <= xmax)%>%
  na.omit()


```

```{r get the timeline of policy moments}

policyTimeline <- readxl::read_xlsx(here::here("data/external/policyMoments.xlsx"))
policyTimeline$year <- as.Date(paste0(policyTimeline$year,"-01-01"))
policyTimeline <- merge(policyTimeline, wos_by_year, bu="year") 
```

```{r PLOT PANEL A}
# For publications in an incomplete year, plot with different linetype
# separaret into complete and incompelete years
oro_branch_by_year_sums1 <- oro_branch_by_year_sums %>%
  filter(year < as.Date("2023-01-01"))
oro_branch_by_year_sums2 <- oro_branch_by_year_sums %>%
  filter(as.Date("2022-01-01") <= year)

# Plot
fig1_A_ggp <- ggplot()+
  
  # Plot complete years
  geom_ribbon(data = oro_branch_by_year_sums, 
              aes(x=year, ymin = log(lower), ymax=log(upper), fill = ORO_branch), alpha = 0.5)+
  geom_line(data = oro_branch_by_year_sums1, aes(x=year, y=log(mean), col=ORO_branch), linewidth = 1,
            na.rm=T)+
  geom_line(data = wos_by_year, 
            aes(x=year, y=log(n_articles), linetype = "WOS"), col="black", linewidth = 1,
            na.rm=T)+
  geom_line(data = scopus_by_year, 
            aes(x=year, y=log(n_articles), linetype = "Scopus"), col="black", linewidth = 1,
            na.rm=T)+
  # Plot incomplete years
  geom_line(data = oro_branch_by_year_sums2, aes(x=year, y=log(mean), col=ORO_branch), linewidth = 0.7,
            na.rm=T, linetype = "dashed")+
  # Add policy moments
  geom_vline(data=policyTimeline, aes(xintercept = year), col="red", linewidth=0.5)+
  geom_text(data=policyTimeline, aes(x = year, y=log(n_articles), label = stringr::str_wrap(event_name,14)), 
            col="red", angle = 90,size=2, vjust=1, hjust=1, nudge_x = 100, nudge_y = -0.5)+
  # Format scales
  scale_color_manual(values = varAES$colour, 
                     name = "ORO branch", guide=guide_legend(order=1, nrow=3), position = "top")+
  scale_fill_manual(values = factor_aes$colour[which(factor_aes$variable == "ORO_branch")], guide = "none")+
  scale_linetype_manual(values = c("solid","dotted"), name = "Oceans & climate literature\ndatabase:",
                        guide=guide_legend(order=2, nrow=2), position = "bottom")+
  labs(x="Year", y="log(N articles)")+
  scale_x_date(limits = c(as.Date("1980-01-01"),xmax))+
  scale_y_continuous(sec.axis = sec_axis(trans = exp, name = "N articles", 
                                         breaks = c(0,100,1000,10000,30000,80000),
                                         labels = function(x) formatC(x, big.mark=",", format="d")),
                     breaks = seq(0,10, by= 2))+
  theme_classic()+
  theme(
    legend.position = "bottom",
    legend.box = "vertical",
    legend.text = element_text(size=8),
    legend.title = element_text(size=10),
    axis.text = element_text(size=7)
    )

fig1_A_ggp
```


# Panel B: Barplot of N articles for each ORO type, filled by % articles in IPCC report. Perhaps also label at the top of the bar the year of the inflexion point of the exponential relationship

```{r load predictions for ORO type}
predRel <- tbl(dbcon, "pred_relevance") 
predType <- tbl(dbcon, "pred_oro_type_long") 
uniquerefs <- tbl(dbcon, "uniquerefs")

## Format and collect needed data
predTypeDf <- predRel %>%
  filter(0.5 <= relevance_mean) %>%
  select(analysis_id) %>%
  inner_join(predType, by ="analysis_id") %>%
  collect()

predTypeRefs <- predType %>%
  left_join(uniquerefs %>% select(analysis_id, year, title, doi), by="analysis_id")%>%
  collect()

uniquerefs <- uniquerefs %>% collect()
```


```{r Sum number of relevant articles for each oro type and boundary}
#factor_aes <- readxl::read_excel(here::here("R/factor_aesthetics.xlsx"))

oroTypeSums <- predTypeDf %>%
  group_by(oro_type) %>%
  summarise(
    n_mean = sum(0.5 <= mean),
    n_lower = sum(0.5 <= lower),
    n_upper = sum(0.5 <= upper)
  ) 


## Format data for plotting by factoring using common aesthetics

# Read in the aethetics for oro_type -- determines order of x axis
typeAES <- factor_aes[which(factor_aes$variable == "oro_type"),]
typeAES <- typeAES[order(typeAES$order),]
# Use to factor oro_type column
oroTypeSums$oro_type <- factor(
  oroTypeSums$oro_type, 
  levels = typeAES$level, labels = typeAES$label
)

# Join in with aesthetics for ORO branch -- determines colour of bar by oro_branch
branchAES <- factor_aes[which(factor_aes$variable == "ORO_branch"),]
branchTypeLookup <- data.frame(
  label = typeAES$label,
  oro_branch = c(rep("Mitigation",3), rep("Natural resilience",2), rep("Societal adaptation",2))
)
typeAES <- merge(typeAES, branchTypeLookup,
                 by = "label") %>%
  rename(oro_type = label)


# Merge sums with plotting order, colour and corresponding branch 
oroTypeSums <- merge(oroTypeSums,typeAES[,c("oro_type","order","colour","oro_branch")])
oroTypeSums$oro_branch <- factor(oroTypeSums$oro_branch,
                                 levels = branchAES$label[branchAES$order])
oroTypeSums$order <- factor(oroTypeSums$order,
                            levels = oroTypeSums$order[order(oroTypeSums$order)])

```

NB the chunk below takes long to run so comment out and load output in next chunk
```{r read in IPCC AR6 bibliographies, eval = FALSE}
# # Read in files as data frames
# bibDir <- here::here("data/external/IPCC-AR6-bibtex-files")
# ipccBib <- rbibtools::read_bib(bibDir, tags = c("year","title","doi"))
# 
# # deduplicate based on year, and defaults to doi followed by title when match_variable is blank
# unique_id = revtools::find_duplicates(data = ipccBib,
#                             group_variables = "year",
#                             match_function = "stringdist", 
#                             method = "osa", threshold = 5,
#                             remove_punctuation = TRUE, to_lower = TRUE)
# length(unique_id) # number of articles = 82438
# sum(duplicated(unique_id)) # number of duplicates = 52445
# # therefore 64 % of articles are duplicates
# 
# ipccBibUnique <- revtools::extract_unique_references(
#   ipccBib, unique_id
# )
# 
# # Assign a bib ID to each unique article
# ipccBibUnique$ipccRef_id <- paste0("ipcc_",seq(1, nrow(ipccBibUnique)))
# 
# # Save
# save(ipccBibUnique,file = file.path(bibDir, "IPCC_AR6_uniquerefs.RData"))

```

NEXT STEP: identify matches between ipcc refs and our database.

See file 'Figure1_ipccTitleMatching_rossi.R' as this was run on the server. Results file is located at the following relative path: 'data/external/IPCC-AR6-bibtex-files/IPCC_AR6_uniquerefs_matches.RData'
```{r clean dataframe on ipcc matches}
## Filter to only records where there is a match for an analysis_id
load(here::here('data/external/IPCC-AR6-bibtex-files/IPCC_AR6_uniquerefs_matches.RData'))
ipccMatches <- ipccMatches[!is.na(ipccMatches$ipccRef_id),]


# ## Load and check that matches make sense
# load(here::here("data/external/IPCC-AR6-bibtex-files/IPCC_AR6_uniquerefs.RData"))
# 
# ipccMatches %>% 
#   select(title, ipccRef_id) %>%
#   head() %>%
#   left_join(ipccBibUnique %>% select(title, ipccRef_id), by= "ipccRef_id")

```

```{r using the title matches sum the number and percentage of matches found in ipcc}

# For each ORO, sum the number of matches to the ipcc
oroMatchesSums <- predTypeDf %>%
  inner_join(ipccMatches, by="analysis_id") %>%
  group_by(oro_type) %>%
  summarise(
    n_mean = sum(0.5 <= mean),
    n_lower = sum(0.5 <= lower),
    n_upper = sum(0.5 <= upper), 
    .drop = FALSE
  ) 


## Format data for plotting by factoring using common aesthetics

# Read in the aethetics for oro_type -- determines order of x axis
typeAES <- factor_aes[which(factor_aes$variable == "oro_type"),]
typeAES <- typeAES[order(typeAES$order),]
# factor oro_type column
oroMatchesSums$oro_type <- factor(
  oroMatchesSums$oro_type, 
  levels = typeAES$level, labels = typeAES$label
)

# Join in with aesthetics for ORO branch -- determines colour of bar by oro_branch
branchAES <- factor_aes[which(factor_aes$variable == "ORO_branch"),]
# typeAES <- merge(typeAES, branchAES[,c("label","colour")] %>%rename(oro_branch = label), 
#                  by = "colour") %>%
#   rename(oro_type = label)
branchTypeLookup <- data.frame(
  label = typeAES$label,
  oro_branch = c(rep("Mitigation",3), rep("Natural resilience",2), rep("Societal adaptation",2))
)
typeAES <- merge(typeAES, branchTypeLookup,
                 by = "label") %>%
  rename(oro_type = label)

# Merge sums with plotting order, colour and corresponding branch 
oroMatchesSums <- merge(oroMatchesSums,typeAES[,c("oro_type","order","colour","oro_branch")])
oroMatchesSums$oro_branch <- factor(oroMatchesSums$oro_branch,
                                 levels = branchAES$label[branchAES$order])
oroMatchesSums$order <- factor(oroMatchesSums$order,
                            levels = oroMatchesSums$order[order(oroMatchesSums$order)])


## Lastly calculate sums as a proportion of total
oroMatchesProp <- merge(oroMatchesSums, oroTypeSums, 
                        by = c("oro_type","order","colour","oro_branch"),
                        suffixes = c(".matches",".total"))
oroMatchesProp <- oroMatchesProp %>%
  mutate(
    prop_mean = n_mean.matches/n_mean.total,
    prop_lower = n_lower.matches/n_lower.total,
    prop_upper = n_upper.matches/n_upper.total
  )
```


```{r plot panel B}
fig1_B_ggp <- ggplot()+
  # plot bars number of model predictions
  geom_col(data=oroTypeSums, aes(x=order, y=n_mean, fill = oro_type))+
  geom_errorbar(data=oroTypeSums, aes(x=order, ymin = n_lower, ymax = n_upper), width=.2)+
  geom_text(data=oroTypeSums, aes(x=order, y=n_upper,label = n_mean), nudge_y = 1000, size=3, col="red")+ #nudge_x=0.2,
  
  # Overlay number of ipcc matches
  # geom_col(data = oroMatchesSums, aes(x=order, y=n_mean),
  #          fill = "darkgrey", alpha = 0.2)+
  #geom_errorbar(data = oroMatchesSums, aes(x=order, ymin = n_lower, ymax = n_upper), width=.2)+
  geom_text(data = oroMatchesProp,
            aes(x=order, y=n_upper.total, label = paste(signif(prop_mean*100, 2),"%")), 
            size=3, col="black", nudge_y = 3500)+ 
  
  # Format scales
  # scale_fill_manual(name = "ORO\nbranch", 
  #                   values = as.vector(branchAES$colour), 
  #                   guide = guide_legend(nrow=3))+
  scale_fill_manual(name = "ORO\ntype", 
                    values = as.vector(typeAES$colour[order(typeAES$order)]), 
                    guide = guide_legend(ncol=2))+
  scale_x_discrete(limits = levels(oroTypeSums$order), 
                    labels = levels(oroTypeSums$oro_type))+
  
  labs(y="N articles")+
  theme(
    panel.background = element_rect(fill="white",colour = "black"),
    panel.grid.major = element_line(colour = "grey"),
    axis.text.y = element_text(size=8),
    axis.text.x = element_text(angle=45, hjust=1, size=8),
    axis.title.x = element_blank(),
    legend.text = element_text(size=7),
    legend.title = element_text(size=10),
    legend.position = "bottom",
    legend.key.size = unit(0.3, "cm"),
    plot.margin = margin(0.1,0.5,0.1,0.1, unit="cm")
  )

fig1_B_ggp
```

# Assemble Panels and write figure

```{r assemble panels and write figure}
pdf(here::here("figures/main/oroBranchTimeAndIpccMatches.pdf"),
    width = 8, height=4.5)
egg::ggarrange(fig1_A_ggp+theme(legend.position = "bottom"), fig1_B_ggp+theme(legend.position = "bottom"),
          nrow=1, ncol=2, newpage = FALSE, labels = c("a.","b."))
dev.off()

```


# Supplementary figure: timeline of mitigation OROs


```{r Sum n articles per mitigation ORO per year}
predRel <- tbl(dbcon, "pred_relevance") 
predType <- tbl(dbcon, "pred_oro_type_long") 
uniquerefs <- tbl(dbcon, "uniquerefs")

## Format and collect needed data
predMitigationDf <- predRel %>%
  filter(0.5 <= relevance_mean) %>%
  select(analysis_id) %>%
  inner_join(predType, by ="analysis_id") %>%
  filter(oro_branch == "Mitigation") %>%
  left_join(uniquerefs %>% select(analysis_id, year), by = "analysis_id") %>%
  collect()



mitigation_oro_by_year_sums <- predMitigationDf %>%
  filter(1980 <= year) %>%
  group_by(oro_type, year) %>%
  summarise(
    mean = sum(0.5 <= mean),
    lower = sum(0.5 <= lower),
    upper = sum(0.5 <= upper)
  ) 


# Factor and format
mitigationAES <- factor_aes[which(factor_aes$level %in% unique(mitigation_oro_by_year_sums$oro_type)),]
mitigationAES$order <- order(mitigationAES$order)
mitigationAES <- mitigationAES[mitigationAES$order,]

mitigation_oro_by_year_sums <- mitigation_oro_by_year_sums%>%
  na.omit() %>%
  mutate(year = as.Date(paste0(year, "-01-01")),
         oro_type = factor(oro_type, levels = mitigationAES$level, labels = mitigationAES$label))


summary(mitigation_oro_by_year_sums)


# text labels
mitigation_oro_text <- mitigation_oro_by_year_sums %>%
  filter(year == as.Date("2020-01-01")) 

```

```{r PLOT timeline of mitigation OROs}

Sfig_mitigation_oro_ggp <- ggplot()+
  geom_ribbon(data = mitigation_oro_by_year_sums, 
              aes(x=year, ymin = log(lower), ymax=log(upper), fill = oro_type), alpha = 0.5)+
  geom_line(data = mitigation_oro_by_year_sums, aes(x=year, y=log(mean), col=oro_type), 
            linewidth = 1,
            na.rm=T)+
  geom_text(data= mitigation_oro_text, 
            aes(x=year, y=log(upper), label = stringr::str_wrap(oro_type, width=30)),
            vjust = "outward", hjust="inward", size=3, col="black")+

  # Format scales
  scale_color_manual(values = mitigationAES$colour, 
                     name = "Mitigation\nORO type", guide=guide_legend(order=1, nrow=1))+
  scale_fill_manual(values = mitigationAES$colour, guide = "none")+
  labs(x="Year", y="log(N articles)")+
  scale_x_date(limits = c(as.Date("1980-01-01"),max(mitigation_oro_by_year_sums$year)))+
  scale_y_continuous(sec.axis = sec_axis(trans = exp, name = "N articles", 
                                         breaks = c(0,100,1000,10000,30000,80000),
                                         labels = function(x) formatC(x, big.mark=",", format="d")),
                     breaks = seq(0,10, by= 2))+
  theme_classic()+
  theme(
    legend.position = "none",
    legend.box = "vertical",
    legend.text = element_text(size=8),
    legend.title = element_text(size=10),
    axis.text = element_text(size=7)
    )


Sfig_mitigation_oro_ggp

ggsave(here::here("figures/supplemental/mitigationOROsTimeline.pdf"), width=6, height=4, units="in")
```





