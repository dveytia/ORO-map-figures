---
title: "Figure4"
author: "Devi Veytia"
date: "2023-12-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Figure description/overview

This figures shows the distribution of ORO types across coastal and marine systems

3 panels 	
a). Infographic of coastal land & built waterfronts (?) / coastal ocean / open ocean 		
b). ORO types vs. CIDs per system
c). ORO types vs. ecosystem types for coastal ocean only

*Key messages:*
1. Shift of ORO types across systems : Coastal land w. Societal adapatation, Coastal ocean w. Renewable energy (& Conservation), Open Ocean w. Mitigation

2. Shift of ecosystem types across OROs: Mangroves for CO2 removal, Coral reef for Conservation / Adapt:Nature, Mangrove / Seagrass for Conservation Adapt:Humans. 

# Set up

```{r load libraries}
library(dplyr)
library(dbplyr)
library(R.utils)
library(RSQLite)
library(ggplot2)
library(cowplot)
```


```{r Get the latest version of sqlite database and connect}

sqliteDir <- here::here("data/sqlite-databases")
sqliteFiles <- dir(sqliteDir)
sqliteVersions <- as.numeric(gsub(".sqlite","",substring(sqliteFiles, regexpr("_v", sqliteFiles) + 2)))
latestVersion <- sqliteFiles[which.max(sqliteVersions)]
dbcon <- RSQLite::dbConnect(RSQLite::SQLite(), file.path(sqliteDir, latestVersion), create=FALSE)
```


```{r import common aesthetics}
factor_aes <- readxl::read_excel(here::here("R/factor_aesthetics.xlsx"))

```

```{r import the summary of model scores}
modelScoresFileName <- dir(here::here("data"))
modelScoresFileName <- modelScoresFileName[grep("model_scores", modelScoresFileName)]

if(length(modelScoresFileName) > 1){
  versionScores <- as.Date(gsub(".csv","", gsub("summary_model_scores_","",modelScoresFileName)))
  modelScoresFileName <- modelScoresFileName[which.max(versionScores)]
}

modelScores <- readr::read_csv(here::here("data", paste(modelScoresFileName)))

```


# Panel A: Infographic of coastal land & built waterfronts (?) / coastal ocean / open ocean

```{r read in svg image of infographic created in inkscape}
## Read in the infographic of the marine systems
msFiles <- dir(here::here("figures/inkscape/"))
msFiles <- msFiles[grep("marineSystems", msFiles)]
msVersions <- as.numeric(gsubfn::strapplyc(msFiles, "_v(.*).svg", simplify = TRUE))


fig4_A_Img <- magick::image_read(here::here(paste0("figures/inkscape/", msFiles[which.max(msVersions)])))

# Plot of the svg infographic 
fig4_A_ggp <- ggdraw()+draw_image(fig4_A_Img, scale = 1)

fig4_A_ggp
```

# Panel B: Heatmap of ORO types vs. CIDs per system



```{r read in data for the plot - use only mean predictions}

## Access relevant tables

predRel <- tbl(dbcon, "pred_relevance") %>%
  filter(0.5 <= relevance_mean) %>%
  select(analysis_id)

predType <- tbl(dbcon, "pred_oro_type_long") %>%
  filter(0.5 <= mean) %>%
  select(analysis_id, oro_branch, oro_type) 

predMarSys <- tbl(dbcon, "pred_marine_system") %>%
  select(analysis_id, 
         `marine_system.land - mean_prediction`,
         `marine_system.coastal ocean - mean_prediction`,
         `marine_system.open-ocean - mean_prediction`) %>% 
  rename(land = `marine_system.land - mean_prediction`,
         coastal_ocean = `marine_system.coastal ocean - mean_prediction`,
         open_ocean = `marine_system.open-ocean - mean_prediction`) %>%
  collect()%>%
  reshape2::melt(id.vars = c("analysis_id"), variable.name = "marine_system", value.name = 'mean') %>%
  filter(0.5 <= mean) %>%
  select(-c(mean))

predThreat <- tbl(dbcon, "pred_climate_threat") %>%
  select(analysis_id,
         `climate_threat.Temperature - mean_prediction`,
         `climate_threat.SLR - mean_prediction`,
         `climate_threat.Extreme_weather - mean_prediction`) %>%
  rename(Temperature = `climate_threat.Temperature - mean_prediction`,
         SLR = `climate_threat.SLR - mean_prediction`,
         Extreme_weather = `climate_threat.Extreme_weather - mean_prediction`) %>%
  collect() %>%
  reshape2::melt(id.vars = c("analysis_id"), variable.name = "climate_threat", value.name = 'mean') %>%
  filter(0.5 <= mean) %>%
  select(-c(mean))
  


## Data joining and calculations
# Format into data frame where each row is a publication (unique analysis_id)

# Include only articles that have a prediction for ORO type AND marine system
marSysTypeThreatDf <- predRel %>%
  inner_join(predType, by="analysis_id") %>%
  collect() %>%
  inner_join(predMarSys, by="analysis_id")

# predictions for climate threat can be optional, because NA value will be classified as 'other'
# so use left_join to add in threats
marSysTypeThreatDf <- marSysTypeThreatDf %>%
  left_join(predThreat, by="analysis_id")

# Tabulate counts for the intersection of the different factors
marSysTypeThreatSums <- marSysTypeThreatDf %>%
  group_by(oro_branch, oro_type, marine_system, climate_threat) %>%
  summarise(n_articles = n())



## Factoring variables for plotting

# retrieve aesthetics for relevant factoring variables
typeAES <- factor_aes[which(factor_aes$variable == "oro_type"),]
typeAES <- typeAES[order(typeAES$order),]
marSysAES <- factor_aes[which(factor_aes$variable == "marine_system"),]
marSysAES <- marSysAES[order(marSysAES$order),]
threatAES <- factor_aes[which(factor_aes$variable == "climate_threat"),]
threatAES <- threatAES[order(threatAES$order),]
threatAES$level[which(threatAES$level == "NA")] <- NA

# use aesthetics to factor variables
marSysTypeThreatSums <- marSysTypeThreatSums %>%
  mutate(
    oro_type = factor(oro_type, levels = typeAES$level, labels = typeAES$label),
    marine_system = factor(marine_system, levels = marSysAES$level, labels = marSysAES$label),
    climate_threat = factor(climate_threat, levels = threatAES$level, labels = threatAES$label, exclude = NULL)
  )

```


```{r quantify the number of articles by marine system}
library(nlme)
marSysFit <- glm(n_articles ~ oro_type*climate_threat*marine_system, data = marSysTypeThreatSums, 
                 family=poisson())

summary(marSysFit)
drop1(marSysFit, test = "Chisq")
# Single term deletions
# 
# Model:
# n_articles ~ oro_type * climate_threat * marine_system
#                                       Df Deviance    AIC    LRT  Pr(>Chi)    
# <none>                                       0.00 476.00                     
# oro_type:climate_threat:marine_system 17   357.82 799.82 357.82 < 2.2e-16 ***
```

```{r old stacked bar plot version}
fig4_B_barplot_ggp <- ggplot(marSysTypeThreatSums, aes(y = oro_type, x=n_articles, fill = climate_threat))+
  facet_wrap(vars(marine_system), ncol=1, scales = "free")+
  geom_col(position = "stack")+
  labs(fill = "Climate impact\ndriver", x = "N articles")+ 
  # colour palette derived from the IBM design library colour blind safe palette
  # https://davidmathlogic.com/colorblind/#%23648FFF-%23785EF0-%23DC267F-%23FE6100-%23FFB000-%235E5C5E
  scale_fill_manual(values = threatAES$colour, breaks = threatAES$label, na.value = "transparent")+ 
  scale_y_discrete(limits = rev)+
  theme_bw()+
  theme(
    #axis.text.x = element_text(angle = 45, hjust=1, vjust=1)
    legend.position = "left",
    axis.title.y = element_blank()
  )

fig4_B_barplot_ggp
```


Plot panel B with the breaks based on quantile

```{r plot panel B breaks based on quantile}
nDat <- marSysTypeThreatSums
nDat$n_articles[which(nDat$climate_threat == "Unidentified")] <- NA
naDat <- marSysTypeThreatSums %>%
            filter(climate_threat == "Unidentified") %>%
            rename(na_articles = n_articles)

# function to scale breaks between 0-1 for inputting values in scale fill stepsn function
range01 <- function(x){(x-min(x))/(max(x)-min(x))} 

# get quantile for climate threat and unidentified datasets separately to get breaks
# because they will be plotted on two different colour scales
breaksFill <- quantile(marSysTypeThreatSums$n_articles[marSysTypeThreatSums$climate_threat != "Unidentified"], na.rm=T) # get the quantile values
breaksFill <- signif(breaksFill, digits = 2) # cap at 2 signif
breaksFill <- round((breaksFill/10))*10 # round to the nearest 10
breaksFill <- unique(breaksFill) # if two quantiles are the same value remove
breaksFill[1] <- 0 # set min to 0

breaksNA <- quantile(naDat$na_articles[marSysTypeThreatSums$climate_threat != "Unidentified"], na.rm=T)
breaksNA <- signif(breaksNA, digits = 2) 
breaksNA <- round((breaksNA/10))*10 
breaksNA <- unique(breaksNA)
breaksNA[1] <- 0

# Plot
fig4_B_quantile_ggp <- ggplot(nDat, aes(x = climate_threat, y=oro_type))+
  facet_grid(vars(marine_system))+
  # Fill for all articles
  geom_tile(aes(fill = n_articles))+
  scale_fill_binned(name = "N articles", 
               type = "viridis",
               breaks = breaksFill, nice.breaks = FALSE,
               labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
               rescaler = scales::rescale,
               #values = range01(breaksFill),
               show.limits = TRUE, 
               limits = breaksFill[c(1, length(breaksFill))], 
               oob= scales::squish,
               na.value = "transparent",
               guide = guide_coloursteps(order = 1),
               position = "top")+ 
  
  # new fill scale for unidentified climate threats
  new_scale_fill()+
  geom_tile(data = naDat,
            aes(fill = na_articles))+
  scale_fill_stepsn(name = "N unidentified", 
                    breaks=breaksNA,
                    labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
                    colours = gray.colors(length(breaksNA)),
                    values = range01(breaksNA),
                    show.limits = TRUE, limits = breaksNA[c(1, length(breaksNA))],
                    na.value = "transparent", 
                    guide = guide_coloursteps(order = 2),
                    position = "bottom")+
  
  # other aesthetics
  labs(x="Climate impact driver")+ 
  scale_y_discrete(limits = rev)+

  theme_bw()+
  theme(
    axis.text.x = element_text(angle = 30, hjust=1, vjust=1),
    legend.position = "left",
    axis.title.y = element_blank(),
    legend.key.width = unit(1, 'cm'),
    legend.key.height = unit(0.4, 'cm')
  )

fig4_B_quantile_ggp
```


plot panel B breaks based on even breaks - does not look great because data are not distributed evenly
```{r plot panel B breaks based on even breaks - does not look great, eval=FALSE}
nDat <- marSysTypeThreatSums
nDat$n_articles[which(nDat$climate_threat == "Unidentified")] <- NA
naDat <- marSysTypeThreatSums %>%
            filter(climate_threat == "Unidentified") %>%
            rename(na_articles = n_articles)



# get even but pretty breaks for each of the datasets
breaksFill <- seq(0, max(marSysTypeThreatSums$n_articles[marSysTypeThreatSums$climate_threat != "Unidentified"], na.rm=T), length.out = 5) # get the quantile values
breaksFill <- signif(breaksFill, digits = 2) # cap at 2 signif
breaksFill <- round((breaksFill/500))*500 # round to the nearest 100
breaksFill <- unique(breaksFill) # if two quantiles are the same value remove

breaksNA <- seq(0, max(naDat$na_articles[marSysTypeThreatSums$climate_threat != "Unidentified"], na.rm=T), length.out = 5)
breaksNA <- signif(breaksNA, digits = 2) 
breaksNA <- round((breaksNA/5000))*5000
breaksNA <- unique(breaksNA)


## Plot
fig4_B_even_ggp <- ggplot(nDat, aes(x = climate_threat, y=oro_type))+
  facet_grid(vars(marine_system))+
  # Fill for all articles
  geom_tile(aes(fill = n_articles))+
  # scale_fill_stepsn(name = "N articles", 
  #                   n.breaks = n_breaksFill, nice.breaks = TRUE,
  #                   labels = function(x) ifelse(1000 <= x, paste(signif(x/1000, digits=2), "k"), paste(x)),
  #                   colors = viridis::viridis(n_breaksFill),
  #                   values = seq(0,1, by=0.25),
  #                   show.limits = TRUE, limits = c(0, max(nDat$n_articles, na.rm = T)),
  #                   na.value = "transparent")+ 
  scale_fill_binned(name = "N articles", 
               type = "viridis",
               breaks = breaksFill, nice.breaks = FALSE,
               labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
               rescaler = scales::rescale,
               #values = range01(breaksFill),
               show.limits = TRUE, 
               limits = breaksFill[c(1, length(breaksFill))], 
               oob= scales::squish,
               na.value = "transparent",
               guide = guide_coloursteps(order = 1),
               position = "top")+ 
  
  # new fill scale
  new_scale_fill()+
  geom_tile(data = naDat,
            aes(fill = na_articles))+
  scale_fill_stepsn(name = "N unidentified", 
                    breaks=breaksNA,
                    labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
                    colours = gray.colors(length(breaksNA)),
                    values = range01(breaksNA),
                    show.limits = TRUE, limits = breaksNA[c(1, length(breaksNA))],
                    na.value = "transparent", 
                    guide = guide_coloursteps(order = 2),
                    position = "bottom")+
  
  # other aesthetics
  labs(x="Climate impact driver")+ 
  
  scale_y_discrete(limits = rev)+
  #coord_flip()+
  theme_bw()+
  theme(
    axis.text.x = element_text(angle = 30, hjust=1, vjust=1),
    legend.position = "left",
    axis.title.y = element_blank(),
    legend.key.width = unit(1, 'cm'),
    legend.key.height = unit(0.4, 'cm')
  )

fig4_B_even_ggp
```

I feel like because the scales are so different between the panels, I will have to normalize by the number of articles in each oro type? Therfore to get 100%, need to sum up the values for that row across all the panels.

```{r plot panel B normalizing by oro type ie by row to make a percentage}
paneltotals <- marSysTypeThreatSums %>%
  group_by(oro_type) %>%
  summarise(total = sum(n_articles))

marSysTypeThreatSumsNorm <- marSysTypeThreatSums %>%
  left_join(paneltotals) %>%
  mutate(percent_articles = n_articles/total*100)

nDat <- marSysTypeThreatSumsNorm
nDat$percent_articles[which(nDat$climate_threat == "Unidentified")] <- NA
naDat <- marSysTypeThreatSumsNorm %>%
            filter(climate_threat == "Unidentified") %>%
            rename(na_articles = percent_articles)


# get even but pretty breaks for each of the datasets
breaksFill <- seq(0, max(marSysTypeThreatSumsNorm$percent_articles[marSysTypeThreatSumsNorm$climate_threat != "Unidentified"], na.rm=T), length.out = 10) # sequence even values across range
breaksFill <- signif(breaksFill, digits = 2) # cap at 2 signif
breaksFill <- round((breaksFill/5))*5 # round 
breaksFill <- unique(breaksFill) # if two quantiles are the same value remove

breaksNA <- seq(0, max(naDat$na_articles[marSysTypeThreatSums$climate_threat != "Unidentified"], na.rm=T), length.out = 5)
breaksNA <- signif(breaksNA, digits = 2) 
breaksNA <- round((breaksNA/5))*5
breaksNA <- unique(breaksNA)


## plot
fig4_B_percent_ggp <- ggplot(nDat, aes(x = climate_threat, y=oro_type))+
  facet_grid(vars(marine_system))+
  # Fill for all articles
  geom_tile(aes(fill = percent_articles))+
  # scale_fill_stepsn(name = "% articles", 
  #                   n.breaks = n_breaksFill, nice.breaks = TRUE,
  #                   labels = function(x){paste(x,"%")},
  #                   colors = viridis::viridis(n_breaksFill),
  #                   show.limits = TRUE, limits = c(0, max(nDat$percent_articles, na.rm = T)),
  #                   na.value = "transparent")+ 
  scale_fill_binned(name = "% articles", 
               type = "viridis",
               breaks = breaksFill, nice.breaks = FALSE,
               labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
               rescaler = scales::rescale,
               #values = range01(breaksFill),
               show.limits = TRUE, 
               limits = breaksFill[c(1, length(breaksFill))], 
               oob= scales::squish,
               na.value = "transparent",
               guide = guide_coloursteps(order = 1, barwidth = unit(4, 'cm')), 
               position = "top")+ 
  
  # new fill scale
  new_scale_fill()+
  geom_tile(data = naDat,
            aes(fill = na_articles))+
  scale_fill_stepsn(name = "% unidentified", 
                    breaks=breaksNA,
                    labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
                    colours = gray.colors(length(breaksNA)),
                    values = range01(breaksNA),
                    show.limits = TRUE, limits = breaksNA[c(1, length(breaksNA))],
                    na.value = "transparent", 
                    guide = guide_coloursteps(order = 2, barwidth = unit(3, 'cm')),
                    position = "bottom")+
  
  # other aesthetics
  labs(x="Climate impact driver")+ 
  
  #scale_y_discrete(limits = rev)+
  #coord_flip()+
  theme_bw()+
  theme(
    axis.text.x = element_text(angle = 30, hjust=1, vjust=1),
    legend.position = "top",
    axis.title.y = element_blank(),
    #legend.key.width = unit(0.4, 'cm'),
    legend.key.height = unit(0.2, 'cm'),
    legend.box = "vertical"
  )

fig4_B_percent_ggp
```



```{r plot panel B normalizing by oro type ie by row to make a percentage with nonlinear colour scale}
## Calculate totals to normalize by ORO type
paneltotals <- marSysTypeThreatSums %>%
  group_by(oro_type) %>%
  summarise(total = sum(n_articles))

marSysTypeThreatSumsNorm <- marSysTypeThreatSums %>%
  left_join(paneltotals) %>%
  mutate(percent_articles = n_articles/total*100)

# nDat <- marSysTypeThreatSumsNorm
# nDat$percent_articles[which(nDat$climate_threat == "Unidentified")] <- NA
# naDat <- marSysTypeThreatSumsNorm %>%
#             filter(climate_threat == "Unidentified") %>%
#             rename(na_articles = percent_articles)

# get breaks for the data
breaksFill <- unique(c(seq(0,60,by=5), seq(50, 100, by=25)))



## Join legend labels with model scores to add F1 statistic to label

# For marine system (strip label)
marSysTypeScores <- modelScores%>% 
  filter(model == "marine_system") %>% 
  select(`label name`, `F1 - label`) %>%
  filter(!is.na(`F1 - label`)) %>%
  mutate(`label name` = recode(`label name`,
                          `land` = "Coastal land",
                          `coastal ocean` = "Coastal ocean",
                          `open-ocean` = "Open-ocean"
                        )) %>%
  rename(label = `label name`, F1_marSys = `F1 - label`)

# For CID (y-axis)
climThreatScores <- modelScores%>% 
  filter(model == "climate_threat_simplified") %>% 
  select(`label name`, `F1 - label`) %>%
  filter(!is.na(`F1 - label`)) %>%
  mutate(`label name` = recode(`label name`,
                          `climate_threat.General_CC` = "Unidentified",
                          `climate_threat.Extreme_weather` = "Extreme weather",
                          `climate_threat.SLR` = "Sea level rise",
                          `climate_threat.Temperature` = "Temperature"
                        )) %>%
  rename(label = `label name`, F1_climThreat = `F1 - label`)%>%
  mutate(label2 = paste0(label,", F1 = ", signif(F1_climThreat, 2))) 

climThreatScoresLabelKey <- climThreatScores$label2
names(climThreatScoresLabelKey) <- climThreatScores$label

# For ORO type (x axis)
oroTypeScores <- modelScores[grep("oro_any", modelScores$model),] %>% 
  select(`label name`, `F1 - label`)%>%
  filter(!is.na(`F1 - label`)) %>%
  mutate(`label name` = recode(`label name`,
                          `oro_any.M_Renewables` = "Marine renewable energy",
                          `oro_any.M_Increase_efficiency` = "CO2 removal or storage",
                          `oro_any.M_CO2_removal_or_storage` = "Increase efficiency",
                          `oro_any.N_Human_assisted_evolution` = "Human-assisted evolution",
                          `oro_any.N_Conservation` = "Conservation",
                          `oro_any.SA_Built_infrastructure_and_technology` = "Built infrastructure & technology",
                          `oro_any.SA_Socioinstitutional` = "Socio-institutional"
                        )) %>%
  rename(label = `label name`, F1_oroType = `F1 - label`) %>%
  mutate(label2 = paste0(label,", F1 = ", signif(F1_oroType, 2))) %>%
  filter(!(label %in% c("oro_any.N_Protection", "oro_any.N_Restoration")))

oroTypeScoresLabelKey <- oroTypeScores$label2
names(oroTypeScoresLabelKey) <- oroTypeScores$label


# Merge labels into dataframe for plotting
marSysTypeThreatSumsNorm2 <- marSysTypeThreatSumsNorm %>%
  merge(climThreatScores,by.x = "climate_threat", by.y = "label", all.x = TRUE) %>% 
  mutate(climate_threat = recode_factor(climate_threat, !!!climThreatScoresLabelKey)) %>%
  merge(marSysTypeScores,by.x = "marine_system", by.y = "label", all.x = TRUE) %>%
  mutate(marine_system = paste0(marine_system,", F1 = ", signif(F1_marSys, 2))) 
  # merge(oroTypeScores,by.x = "oro_type", by.y = "label", all.x = TRUE, all.y = FALSE) %>%
  # mutate(oro_type = recode_factor(oro_type, !!!oroTypeScoresLabelKey))
  



## plot
fig4_B_percent_nonlinear_ggp <- ggplot(marSysTypeThreatSumsNorm2, 
                                       aes(y = climate_threat, x=oro_type))+
  facet_grid(vars(marine_system), labeller = label_wrap_gen(width=15))+
  # Fill for all articles
  geom_tile(aes(fill = percent_articles))+
  # scale_fill_stepsn(name = "% articles", 
  #                   n.breaks = n_breaksFill, nice.breaks = TRUE,
  #                   labels = function(x){paste(x,"%")},
  #                   colors = viridis::viridis(n_breaksFill),
  #                   show.limits = TRUE, limits = c(0, max(nDat$percent_articles, na.rm = T)),
  #                   na.value = "transparent")+ 
  scale_fill_binned(name = "% articles", 
               type = "gradient", 
               low = RColorBrewer::brewer.pal(5,"Blues")[1], 
               high = "#0570b0",
               breaks = breaksFill, nice.breaks = FALSE,
               labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
               rescaler = scales::rescale,
               #values = range01(breaksFill),
               show.limits = TRUE, 
               limits = breaksFill[c(1, length(breaksFill))], 
               oob= scales::squish,
               na.value = "transparent",
               guide = guide_coloursteps(order = 1), #barwidth = unit(0.5, 'cm') 
               position = "top")+ 
  
  
  geom_text(aes(label = formatC(n_articles, format="d", big.mark = ",")), 
            col="black", size=3)+
  
  # other aesthetics
  labs(y="Climate impact driver", x="ORO type")+ 
  geom_vline(xintercept = c(3.5, 5.5), col="red", linewidth = 1.5)+
  
  #scale_y_discrete(limits = rev)+
  #coord_flip()+
  theme_bw()+
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust=1, vjust=1, size=9),
    axis.text.y = element_text(size=9),
    #legend.position = "right",
    legend.position = "top",
    axis.title.x = element_blank(),
    legend.key.height = unit(0.35, 'cm'),
    legend.key.width = unit(1, 'cm'),
    #legend.key.width = unit(0.3, 'cm'),
    #legend.key.height = unit(0.8, 'cm'),
    legend.text = element_text(size=6)
    #legend.box = "vertical"
  )

fig4_B_percent_nonlinear_ggp
```


# Panel C: Heatmap of ORO types vs. ecosystem types and outcome for coastal ocean only

```{r get phylopics for ecosystem type}
pics <- dir(here::here("figures/phylopics/"))

# get mangrove
if(!("mangrove.svg" %in% pics)){
  mangrove_uuid <- rphylopic::get_uuid(name = "Rhizophora mangle", n=5)
  mangrove_img <- rphylopic::pick_phylopic(name = "Rhizophora mangle", n = 1)
  mangrove_img <- rphylopic::get_phylopic("bacc6a59-80d2-461c-92d4-83cabc91cc39")
  rphylopic::save_phylopic(img=mangrove_img,
                path = here::here("figures/phylopics/mangrove.svg"))
}


# Get coral
if(!("coral.svg" %in% pics)){
  coral_img <- rphylopic::get_phylopic("32eeaa29-2e90-40b5-92fb-eb8d7fcab9ab")
  rphylopic::save_phylopic(img = coral_img,
              path = here::here("figures/phylopics/coral.svg"))
}


# Get macroalgae
if(!("macroalgae.svg" %in% pics)){
  macro_img <- rphylopic::get_phylopic("9acf11fa-89dd-4a56-b3da-8665c406c6f5")
  rphylopic::save_phylopic(img = macro_img,
              path = here::here("figures/phylopics/macroalgae.svg"))
}


# get seagrass -- for some reason I had to download this directly from the website
#seagrass_img <- rphylopic::get_phylopic("2534e10f-ea8e-436e-a8c8-13ac045eb867")
#rphylopic::save_phylopic(img = seagrass_img,
#              path = here::here("figures/phylopics/seagrass.svg"))


library(magick)
marsh_ras <- as.raster(image_fill(image_read(here::here("figures/phylopics/saltmarsh.jpg")),'none'))
mangrove_ras <- as.raster(image_fill(image_read_svg(here::here("figures/phylopics/mangrove.svg")),'none'))
coral_ras <- as.raster(image_fill(image_read_svg(here::here("figures/phylopics/coral.svg")),'none'))
macro_ras <- as.raster(image_fill(image_read_svg(here::here("figures/phylopics/macroalgae.svg")),'none'))
seagrass_ras <- as.raster(image_fill(image_read_svg(here::here("figures/phylopics/seagrass.svg")),'none'))

```



```{r Changing salt marsh prediction boundary exploration and scoping}
source(here::here("R/bool_detect.R"))
source(here::here("R/clean_string.R"))
source(here::here("R/utils.R"))

## Access relevant tables
uniquerefs <- tbl(dbcon, "uniquerefs") %>% 
  select(analysis_id, title, abstract, keywords)

predMarSys <- tbl(dbcon, "pred_marine_system") %>%
  select(analysis_id, 
         `marine_system.land - mean_prediction`,
         `marine_system.coastal ocean - mean_prediction`,
         `marine_system.open-ocean - mean_prediction`) %>% 
  rename(land = `marine_system.land - mean_prediction`,
         coastal_ocean = `marine_system.coastal ocean - mean_prediction`,
         open_ocean = `marine_system.open-ocean - mean_prediction`) %>%
  collect()%>%
  reshape2::melt(id.vars = c("analysis_id"), variable.name = "marine_system", value.name = 'mean') %>%
  filter(0.5 <= mean) %>%
  select(-c(mean))

saltMarshDf <- tbl(dbcon, "pred_ecosystem_type") %>%
  select(analysis_id,`ecosystem_type.Salt_marsh - mean_prediction`, 
         `ecosystem_type.Salt_marsh - mean_prediction`) %>%
  rename(mean = `ecosystem_type.Salt_marsh - mean_prediction`,
         upper = `ecosystem_type.Salt_marsh - mean_prediction`) %>%
  left_join(uniquerefs, by = "analysis_id") %>%
  collect() %>%
  reshape2::melt(id.vars = c("analysis_id", "title","abstract","keywords"), variable.name = "Prediction_boundary", value.name = "Prediction")

saltMarshDf <- saltMarshDf %>%
  mutate(text = clean_string(paste(title, abstract, keywords))) %>%
  #select(-c(title, abstract, keywords)) %>%
  mutate(match = bool_detect(text, "salt AND marsh*")) 


## How many matches for salt marsh terms are there? 
sumSaltMarshMatches <- saltMarshDf %>%
  mutate(Threshold = ifelse(0.5 <= Prediction, "above 0.5 threshold","below 0.5 threshold")) %>%
  group_by(Prediction_boundary, Threshold) %>%
  summarise(n_matches = sum(match), n_total = n(), percent_matches = n_matches/n_total*100)

#   Prediction_boundary Threshold           n_matches n_total percent_matches
#   <fct>               <chr>                   <int>   <int>           <dbl>
# 1 mean                below 0.5 threshold      1095   61656           1.78 
# 2 upper               above 0.5 threshold       814   15428           5.28 
# 3 upper               below 0.5 threshold       281   46228           0.608

# So really, the number of keyword matches are pretty small in comparison to the number of articles predicted relevant. Using the upper threshold at 0.5, that's 5 % of all articles predicted relevant have the words "salt marsh" in them. 


## Save results file
# write.csv(sumSaltMarshMatches, file = here::here("outputs/saltMarshKeywordMatches.csv"))

# Aesthetics for plotting
marSysAES <- factor_aes[which(factor_aes$variable == "marine_system"),]
marSysAES <- marSysAES[order(marSysAES$order),]



## Plot supplementary figure
saltMarshPredictions_ggp <- ggplot(saltMarshDf, aes(x=Prediction, fill = Prediction_boundary))+
  geom_histogram(alpha = 0.25, col = "black")+
  #geom_vline(xintercept = quantile(saltMarshDf$Prediction[saltMarshDf$Prediction_boundary == "upper"], probs=0.5)) +
  #annotation_raster(marsh_ras, 0.6, 0.9, 29000, 45000)+
  labs(y = "N articles", x = "Prediction", fill = "Prediction boundary"
    #caption = paste("Vertical line at 50% quantile for upper prediction =",
    #              signif(quantile(saltMarshDf$Prediction[saltMarshDf$Prediction_boundary == "upper"],
    #                              probs=0.5), digits=2))
    )+
  theme_classic()+
  theme(
    legend.position = "bottom"
  )



saltMarshMarSys_ggp <- saltMarshDf %>%
  filter(Prediction_boundary == "upper" & 
           0.5 <= Prediction) %>%
  left_join(predMarSys, by="analysis_id") %>% 
  mutate(marine_system = factor(marine_system, levels = marSysAES$level, marSysAES$label, exclude=FALSE)) %>%
  ggplot(aes(x=marine_system)) +
  geom_bar()+
  annotation_raster(marsh_ras, 3, 4.5, 25000, 40000)+
  labs(y="N articles", x="Marine system"#,
       #caption = "Using a threshold of 0.4 for relevance"
       )+
  theme_classic()+
  theme(
    axis.text.x = element_text(angle=45, vjust=1, hjust=1)
  )

## Save figure
pdf(here::here("figures/supplemental/saltMarshPredictionsHistogramAndMarineSystem.pdf"),
    width = 7, height=4.5)
egg::ggarrange(saltMarshPredictions_ggp, saltMarshMarSys_ggp,
          nrow=1, ncol=2, newpage = FALSE, labels = c("a.","b."))
dev.off()


# Sample articles with a predicted relevance > 0.8, and words with and without salt marsh

saltmarshScope <- saltMarshDf %>%
  filter(Prediction_boundary == "mean") %>%
  #filter(0.5 <= Prediction) %>%
  #arrange(desc(Prediction)) %>%
  group_by(match) %>%
  #slice_head(n = 50) %>%
  slice_sample(n=50) %>%
  select(-c(text))

writexl::write_xlsx(saltmarshScope, path = here::here("outputs/saltMarshArticleScoping.xlsx"))


saltmarshScope_coded <- readxl::read_xlsx(here::here("outputs/saltMarshArticleScoping_coded.xlsx"))

saltmarshScope_coded <- saltmarshScope_coded %>%
  mutate(`Manual check` = tolower(`Manual check`))

saltmarsh_scope <- ggplot(data = saltmarshScope_coded, aes(`Manual check`, Prediction))+
  geom_boxplot()+
  theme_bw()+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

saltmarsh_scope
```


Notes for changes in analysis - No predictions for salt marsh at mean prediction b/c low recall. However we decided to keep using the mean value with 0.5 cutoff to avoid having results for salt marsh that were not comparable to other ecosystem type labels because of higher amounts of noise. 


```{r read in data for the plot}

## Access relevant tables
predRel <- tbl(dbcon, "pred_relevance") %>%
  filter(0.5 <= relevance_mean) %>%
  select(analysis_id)

predType <- tbl(dbcon, "pred_oro_type_long") %>%
  filter(0.5 <= mean) %>%
  select(analysis_id, oro_branch, oro_type) 

predMarSys <- tbl(dbcon, "pred_marine_system") %>%
  select(analysis_id, 
         `marine_system.land - mean_prediction`,
         `marine_system.coastal ocean - mean_prediction`,
         `marine_system.open-ocean - mean_prediction`) %>% 
  rename(land = `marine_system.land - mean_prediction`,
         coastal_ocean = `marine_system.coastal ocean - mean_prediction`,
         open_ocean = `marine_system.open-ocean - mean_prediction`) %>%
  collect()%>%
  reshape2::melt(id.vars = c("analysis_id"), variable.name = "marine_system", value.name = 'mean') %>%
  filter(0.5 <= mean) %>%
  select(-c(mean))

# NB here I no longer change the filtering so salt marsh is included using mean pred not upper
predEcoType <- tbl(dbcon, "pred_ecosystem_type") %>%
  select(analysis_id,
         `ecosystem_type.Salt_marsh - mean_prediction`, ## ** `ecosystem_type.Salt_marsh - mean_prediction`
         `ecosystem_type.Mangrove - mean_prediction`,
         `ecosystem_type.Coral_reef - mean_prediction`,
         `ecosystem_type.Seagrass - mean_prediction`) %>%
  rename(Salt_marsh = `ecosystem_type.Salt_marsh - mean_prediction`,
         Mangrove = `ecosystem_type.Mangrove - mean_prediction`,
         Coral_reef = `ecosystem_type.Coral_reef - mean_prediction`,
         Seagrass = `ecosystem_type.Seagrass - mean_prediction`) %>%
  collect() %>%
  reshape2::melt(id.vars = c("analysis_id"), variable.name = "ecosystem_type", value.name = 'prediction') %>%
  #filter(0.5 <= mean) %>%
  mutate(relevant = ifelse((ecosystem_type == "Salt_marsh" & 0.5 <= prediction) |
                             (ecosystem_type != "Salt_marsh" & 0.5 <= prediction), 1,0)) %>%
  filter(relevant == 1) %>%
  select(-c(prediction, relevant))

# Outcomes
predMit <- tbl(dbcon, "pred_climate_mitigation") %>%
  select(analysis_id, `0 - relevance - mean_prediction`) %>%
  rename(climate_mitigation = `0 - relevance - mean_prediction`) %>%
  #filter(0.5 <= climate_mitigation) %>%
  collect()

predAdapt <- tbl(dbcon, "pred_adapt_to_threat") %>%
  select(analysis_id,
         `adapt_to_threat.Human - mean_prediction`,
         `adapt_to_threat.Natural - mean_prediction`) %>%
  rename(Human = `adapt_to_threat.Human - mean_prediction`,
         Natural = `adapt_to_threat.Natural - mean_prediction`) %>%
  collect() 
  #reshape2::melt(id.vars = c("analysis_id"), variable.name = "adapt_to_threat", value.name = 'mean') %>%
  #filter(0.5 <= mean) 



## Retrieve aesthetics for relevant factoring variables
typeAES <- factor_aes[which(factor_aes$variable == "oro_type"),]
typeAES <- typeAES[order(typeAES$order),]
ecoTypeAES <- factor_aes[which(factor_aes$variable == "ecosystem_type"),]
ecoTypeAES <- ecoTypeAES[order(ecoTypeAES$order),]
adaptAES <- factor_aes[which(factor_aes$variable == "adapt_to_threat"),]
adaptAES <- adaptAES[order(adaptAES$order),]
```


Why are there a high number of salt marsh papers with mitigation outcomes and marine renewable energy predicted?
```{r Investigate the ecosystem x outcome for MRE}
MRE_Df <- predRel %>%
  inner_join(predType, by="analysis_id") %>%
  filter(oro_type == "Marine renewable energy" ) %>%
  collect() %>%
  inner_join(predMarSys, by="analysis_id") %>%
  #filter(marine_system == "coastal_ocean") %>%
  inner_join(predEcoType, by="analysis_id") %>%
  # Use left_join to add outcomes
  left_join(predMit, by="analysis_id") %>%
  left_join(predAdapt, by="analysis_id") %>%
  reshape2::melt(measure.vars = c("climate_mitigation","Human","Natural"), variable.name = "Outcome",
                 value.name = "Prediction") %>% 
  group_by(marine_system, ecosystem_type, Outcome) %>%
  summarise(n_articles = sum(0.5 <= Prediction))

MRE_ggp <- ggplot(MRE_Df, aes(x=ecosystem_type, y=Outcome, fill=n_articles))+
  facet_wrap(vars(marine_system))+
  geom_tile()

MRE_ggp


## Investigate these papers & their topics using a Latent Dirichlet Allocation topic model

# Filter to articles in this area
uniquerefs <- tbl(dbcon, "uniquerefs") %>% 
  select(analysis_id, title, abstract, keywords)

MRE_saltMarsh <- predRel %>%
  inner_join(predType, by="analysis_id") %>%
  filter(oro_type == "Marine renewable energy" ) %>%
  collect() %>%
  inner_join(predMarSys, by="analysis_id") %>%
  inner_join(predEcoType, by="analysis_id") %>%
  left_join(predMit, by="analysis_id") %>%
  filter(ecosystem_type == "Salt_marsh", 0.5 <= climate_mitigation, marine_system == "coastal_ocean") %>%
  inner_join(uniquerefs, by = "analysis_id", copy=TRUE)


# Are there any keyword matches for salt marshes?
source(here::here("R/bool_detect.R"))
source(here::here("R/clean_string.R"))
source(here::here("R/utils.R"))
MRE_saltMarsh$text <- clean_string(paste(
  MRE_saltMarsh$title, MRE_saltMarsh$abstract, MRE_saltMarsh$keywords))
marshMatches <- bool_detect(MRE_saltMarsh$text, "salt AND marsh*")
sum(marshMatches) # 0 


# So what are these papers about? -- Calculate topic model
all_stopwords <- unique(c(litsearchr::get_stopwords("English"), revtools::revwords()))
x_dtm <- revtools::make_dtm(MRE_saltMarsh$text, stop_words = all_stopwords)
x_lda <- revtools::run_topic_model(x_dtm, "lda", 5, 5000)
save(x_dtm, x_lda, file=here::here("outputs/saltMarshAndMRETopicModel.RData")) # save
load(here::here("outputs/saltMarshAndMRETopicModel.RData"))

docTopics <- topicmodels::topics(x_lda) # topic assigned to each document
top5termsPerTopic <- topicmodels::terms(x_lda, 5) # top 5 terms in each topic 
topicNames <- apply(top5termsPerTopic, 2, paste, collapse=" ") # use to create a topic name

docTopicDf <- data.frame(
  document_ID = names(docTopics),
  topicNumber = docTopics,
  topicName = topicNames[docTopics]
)

ggplot(docTopicDf, aes(x=docTopics, fill=topicName))+
  geom_bar()+
  labs(x="Topic Number", fill = "Top 5\ntopic terms",
       caption = paste("N documents with pollut* term matches =", length(x_lda@documents)))+
  theme_classic()


```



```{r Format dataframes and calculate sums for heatmaps}
## Data joining

# Format into data frame where each row is a publication (unique analysis_id)

# Include only articles that have a prediction for ORO type AND coastal marine system and ecosystem type
coastEcoTypeDf <- predRel %>%
  inner_join(predType, by="analysis_id") %>%
  collect() %>%
  inner_join(predMarSys, by="analysis_id") %>%
  filter(marine_system == "coastal_ocean") %>%
  inner_join(predEcoType, by="analysis_id")

# Use left_join to add outcomes
coastEcoTypeDf <- coastEcoTypeDf %>%
  left_join(predMit, by="analysis_id") %>%
  left_join(predAdapt, by="analysis_id")


# coastEcoTypeDf %>%
#   group_by(oro_type, ecosystem_type) %>%
#   summarise(climate_mitigation = sum(0.5 <= climate_mitigation))
# ggplot(
#          , aes(x=ecosystem_type, y=climate_mitigation))

## Factoring variables for plotting

# use aesthetics to factor variables
coastEcoTypeDf <- coastEcoTypeDf %>%
  mutate(
    oro_type = factor(oro_type, levels = typeAES$level, labels = typeAES$label),
    ecosystem_type = factor(ecosystem_type, levels = ecoTypeAES$level, labels = ecoTypeAES$label)
  )



# Tabulate counts for the intersection of the different factors
library(tidyr)
mitigationSums <- coastEcoTypeDf %>%
  group_by(oro_branch, oro_type, ecosystem_type) %>%
  summarise(n_articles = sum(0.5 <= climate_mitigation)) %>% #, na.rm=TRUE
  complete(ecosystem_type, fill = list(n_articles = 0))

adaptationSums <- coastEcoTypeDf %>%
  group_by(oro_branch, oro_type, ecosystem_type) %>%
  summarise(Human = sum(0.5 <= Human),
            Natural = sum(0.5 <= Natural)) %>%
  reshape2::melt(measure.vars = c("Human","Natural"), 
                 variable.name = "adapt_to_threat", value.name = "n_articles") %>%
  mutate(adapt_to_threat = factor(adapt_to_threat, levels = adaptAES$level, labels = adaptAES$label),
         n_articles = ifelse(is.na(n_articles),0, n_articles))


# Normalise by number of articles per ORO to get a percent

# calculate number of unique articles per oro type
# divide sums by these totals to get a percent of all coastal ecosystems
oroTotalsDF <- coastEcoTypeDf %>%
  filter(0.5 <= climate_mitigation |
           0.5 <= Human | 0.5 <= Natural) %>%
  group_by(oro_type) %>%
  summarise(total_coastEco = n_distinct(analysis_id))

mitigationSums <- mitigationSums %>%
  left_join(oroTotalsDF, by = "oro_type") %>%
  mutate(percent_articles = n_articles/total_coastEco*100)

adaptationSums <- adaptationSums %>%
  left_join(oroTotalsDF, by = "oro_type") %>%
  mutate(percent_articles = n_articles/total_coastEco*100)

# But also the percent may be low in comparison to all the articles out there for that ORO
# So also show the percentage that coastal ecosystem articles compose of total articles (coastEcoFraction)
oroTotalsDF_All <- predRel %>%
  inner_join(predType, by="analysis_id") %>%
  group_by(oro_type) %>%
  summarise(total_All = n_distinct(analysis_id))%>%
  collect() %>%
  mutate(oro_type = factor(oro_type, levels = typeAES$level, labels = typeAES$label)) 

mitigationSums <- mitigationSums %>%
  left_join(oroTotalsDF_All%>% select(oro_type, total_All), by = "oro_type") %>%
  mutate(percent_All = n_articles/total_All*100)
mitigationSums$coastEcoFraction = mitigationSums$total_coastEco/mitigationSums$total_All

adaptationSums <- adaptationSums %>%
  left_join(oroTotalsDF_All%>% select(oro_type, total_All), by = "oro_type") %>%
  mutate(percent_All = n_articles/total_All*100)
adaptationSums$coastEcoFraction = adaptationSums$total_coastEco/adaptationSums$total_All



## Format for a bivariate fill legend

library(biscale)

# Make my own bivariate palette
biPal5 <- c("#ffffff", "#d8f2f2", "#b0e5e5", "#86d7d7", "#5ac8c8", "#efd9ea", "#cacede", "#a5c3d2", "#7eb7c5", "#54aab8", "#dfb2d6", "#bda9cb", "#9aa0c0", "#7596b4", "#4f8ca8", "#cf8cc1", "#af85b7", "#8f7ead", "#6d76a3", "#496e97", "#be64ac", "#a15fa3", "#835a9a", "#645491", "#434e87")
palNames <- expand.grid(as.character(1:5), as.character(seq(1,5)))
palNames <- paste(palNames$Var1, palNames$Var2, sep="-")
names(biPal5) <- palNames
bi_pal(pal = biPal5, dim = 5) # Preview palette

# Make my own breaks 
library(classInt)
# The percentage of coastal ecosystem articles
brks1 <- classIntervals(c(mitigationSums$percent_articles, adaptationSums$percent_articles),n=5, style = "kmeans")$brks
# The fraction of all articles made up by coastal ecosystem articles
brks2 <- classIntervals(c(mitigationSums$coastEcoFraction, adaptationSums$coastEcoFraction), n=5,
                        style = "quantile")$brks
# cut data
mitigationSums$percent_articles_cut <- cut(mitigationSums$percent_articles, breaks = brks1, include.lowest = T)
adaptationSums$percent_articles_cut <- cut(adaptationSums$percent_articles, breaks = brks1, include.lowest = T)
mitigationSums$coastEcoFraction_cut <- cut(mitigationSums$coastEcoFraction, breaks = brks2, include.lowest = T)
adaptationSums$coastEcoFraction_cut <- cut(adaptationSums$coastEcoFraction, breaks = brks2, include.lowest = T)

# Format data frames for bivariate plotting
# Manually set 0 articles to class 1-1 otherwise it's counter intutitive
mitigationSums <- bi_class(mitigationSums, x=percent_articles_cut, y=coastEcoFraction_cut, dim=5, style = "equal")
mitigationSums$bi_class <- ifelse(mitigationSums$n_articles == 0, "1-1",mitigationSums$bi_class)

adaptationSums <- bi_class(adaptationSums, x=percent_articles_cut, y=coastEcoFraction_cut, dim=5, style = "equal")
adaptationSums$bi_class <- ifelse(adaptationSums$n_articles == 0, "1-1",adaptationSums$bi_class)


# calculate labels
labs <- bi_class_breaks(mitigationSums, x=percent_articles_cut, y = coastEcoFraction, style = "equal",
                dim = 5, dig_lab = 1, split = TRUE)



## For the adaptation plot, want to display two variables in triangles
# so format data for plotting
source(here::here("R/getTiles.R"))
source(here::here("R/getTileCentre.R"))

humanDf <- getTiles(df = adaptationSums, filterVar = "adapt_to_threat", filterVal = "Human", 
                    orderVars = c(y="oro_type",x="ecosystem_type"),
                    tileLoc = "bottomright")
humanDfText <- getTileCentre(df = adaptationSums, filterVar = "adapt_to_threat", 
                             filterVal = "Human", 
                    orderVars = c(y="oro_type",x="ecosystem_type"),
                    tileLoc = "bottomright")
natureDf <- getTiles(df = adaptationSums, filterVar = "adapt_to_threat", filterVal = "Nature", 
                    orderVars = c(y="oro_type",x="ecosystem_type"),
                    tileLoc = "topleft"
                    )
natureDfText <- getTileCentre(df = adaptationSums, filterVar = "adapt_to_threat", filterVal = "Nature", 
                    orderVars = c(y="oro_type",x="ecosystem_type"),
                    tileLoc = "topleft"
                    )

```


```{r export sums to csv for reference}
write.csv(mitigationSums, here::here("outputs/coastalEcosystemsMitigationSums.csv"))
write.csv(adaptationSums, here::here("outputs/coastalEcosystemsAdaptationSums.csv"))
```


```{r quantify the number of articles by ecosystem type}
library(nlme)
mitigationFit <- glm(n_articles ~ oro_type*ecosystem_type, data = mitigationSums, 
                 family=poisson())

drop1(mitigationFit, test = "Chisq") # delta AIC = 323.82

# Model:
# n_articles ~ oro_type * ecosystem_type
#                         Df Deviance    AIC    LRT  Pr(>Chi)    
# <none>                         0.00 103.87                     
# oro_type:ecosystem_type 15   152.94 226.81 152.94 < 2.2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


adaptationFit <- glm(n_articles ~ oro_type*ecosystem_type, data = adaptationSums %>%
                       group_by(oro_type, ecosystem_type) %>%
                       summarise(n_articles = sum(n_articles,na.rm=T)), 
                 family=poisson())
drop1(adaptationFit, test = "Chisq")

# Model:
# n_articles ~ oro_type * ecosystem_type
#                         Df Deviance    AIC    LRT  Pr(>Chi)    
# <none>                         0.00 127.10                     
# oro_type:ecosystem_type  9   776.24 885.33 776.24 < 2.2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
```


```{r plot panel C.i - Mitigation as a bivariate map}
fig4_C_i <- ggplot(mitigationSums%>% filter(0<n_articles), aes(y=oro_type, x=ecosystem_type))+
  geom_tile(aes(fill = bi_class), show.legend = FALSE)+
  geom_text(data=mitigationSums %>% filter(0<n_articles),
            aes(label = formatC(n_articles, format="d", big.mark=",")), col="black", size=4)+
  bi_scale_fill(pal = biPal5, dim=5, na.value = "white")+
  #scale_fill_gradient2(mid="white",high="#3182bd", midpoint = 0, guide = guide_coloursteps())+
  #scale_y_discrete(limits=rev)+
  geom_hline(yintercept = c(3.5,5.5), col="black", linewidth=1)+
  # annotation_raster(marsh_ras, 0.5, 1.5, -2, -0)+
  # annotation_raster(mangrove_ras, 1.5, 2.5, -2, -0)+
  # annotation_raster(seagrass_ras, 2.5, 3.5, -2, -0)+
  # annotation_raster(coral_ras, 3.5, 4.5, -2, -0)+
  # coord_cartesian(ylim = c(-1.5, length(levels(mitigationSums$oro_type))), clip = 'off')+
  labs(
    x = "Ecosystem type", #y = "ORO type", 
    title = "i. Mitigation"
  )+
  coord_flip()+ # Added this -- double check
  theme_bw()+
  theme(
    #axis.title.y = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    #axis.text.x = element_text(angle=45, vjust=1, hjust=1)
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(size=11)
  )



finalPlot <- ggdraw() +
  draw_plot(fig4_C_i, 0, 0, 1, 1) 
  #draw_plot(biLegend, 0, 0, 0.4, 0.4)


finalPlot
```


```{r plot panel C.ii - Adaptation as a bivariate map}
# cii_text <- data.frame(
#   x=c(0.75,1.25),
#   y=c(nrow(typeAES)+0.5,
#       nrow(typeAES)-0.5),
#   labs = c("Nature", "Human")
# )
cii_text <- data.frame(
  x=c(nrow(ecoTypeAES)+0.45, nrow(ecoTypeAES)-0.45),
  y=c(0.55,1.45),
  labs = c("Nature", "Human")
)



fig4_C_ii <- ggplot()+
  geom_polygon(data = humanDf %>% filter(0<n_articles), aes(x,y,group=id, fill = bi_class), show.legend = FALSE, col="darkgrey")+
  geom_polygon(data = natureDf%>% filter(0<n_articles), aes(x,y,group=id, fill = bi_class), show.legend = FALSE, col="darkgrey")+
  # geom_text(data=cii_text%>%filter(labs == "Nature"), aes(x, y, label = labs), size=2, hjust="inward", vjust="inward")+
  # geom_text(data=cii_text%>%filter(labs == "Human"), aes(x, y, label = labs), size=2, hjust="outward", vjust="outward")+
  
  # Add text of article numbers 
  geom_text(data=rbind(humanDfText, natureDfText)%>% filter(0<n_articles), aes(x,y,label = formatC(n_articles, format="d", big.mark = ",")),
            col="black", size=3)+
  
  bi_scale_fill(pal = biPal5, dim=5, na.value = "white")+
  
  geom_hline(yintercept = c(3.5,5.5), col="black", linewidth=1)+

  # annotation_raster(marsh_ras, 0.5, 1.5, -2, -0)+
  # annotation_raster(mangrove_ras, 1.5, 2.5, -2, -0)+
  # annotation_raster(seagrass_ras, 2.5, 3.5, -2, -0)+
  # annotation_raster(coral_ras, 3.5, 4.5, -2, -0)+
  
  # # Format axes
  scale_x_continuous(breaks = 1:nrow(ecoTypeAES),labels = ecoTypeAES$label)+
  scale_y_continuous(breaks = 1:nrow(typeAES),labels = stringr::str_wrap(typeAES$label, width=20))+
  # scale_y_binned(breaks = 1:nrow(typeAES),labels = typeAES$label)+ #, limits = c(1,nrow(typeAES))
  # 
  # coord_cartesian(ylim = c(0.5, nrow(typeAES)+0.5), clip = 'off')+
  labs(
    x = "Ecosystem type", #y = "ORO type", 
    title = "ii. Adaptation"
  )+
  coord_flip()+ # added this -- double check
  theme_bw()+
  theme(
    #plot.margin = unit(c(0,0,0,0), "cm"),
    axis.title.x = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    axis.text.x = element_text(angle=45, vjust=1, hjust=1, size=11),
    axis.text.y = element_text(size=11)
    #axis.title.x = element_text(vjust = -8)
  )


finalPlot2 <- ggdraw() +
  draw_plot(fig4_C_ii, 0, 0, 1, 1) 
  #draw_plot(biLegend, 0, 0, 0.4, 0.4)


finalPlot2
```


```{r plot of legend}
labs2 <- labs
labs2$bi_x <- round(labs2$bi_x)
labs2$bi_y <- labs2$bi_y*100 # turn into percentage
biLegend <- bi_legend(pal = biPal5,
                    dim = 5,
                    xlab = "% coastal ecosystem",
                    ylab = "% of all",
                    breaks = labs2,
                    arrows=FALSE,
                    size = 9)
biLegend <- biLegend+theme(
  panel.background = element_rect(fill="transparent"),
  plot.background = element_rect(fill='transparent', color=NA))
```

```{r combine two panel C subplots together}
fig4_C <- plot_grid(finalPlot, 
                    finalPlot2+draw_plot(biLegend, x=-0.23, y=0, width=0.35, height=0.35),
                    nrow=2, rel_heights = c(0.7,1))
fig4_C
```


```{r save full figure of panel C as a supplementary figure}
pdf(file = here::here("figures/supplemental/climateImpactDriversCoastalEcosystems_allOutcomes.pdf"), width =6, height = 7)

plot_grid(fig4_C+theme(plot.margin = unit(c(0,0,0,3), "cm")))

while (!is.null(dev.list())) dev.off()

```


```{r simplify panel C to combine mitigation and adaptation outcomes into one panel}
cii_text <- data.frame(
  x=c(nrow(ecoTypeAES)+0.45, nrow(ecoTypeAES)-0.45),
  y=c(0.55,1.45),
  labs = c("Nature", "Human")
)

## Join y axis labels for ecosystem type with model scores
ecoTypeScores <- modelScores[modelScores$model == "ecosystem_type_simplified2",] %>% 
  select(`label name`, `F1 - label`)%>%
  filter(!is.na(`F1 - label`)) %>%
  mutate(`label name` = recode(`label name`,
                          `ecosystem_type.Salt_marsh` = "Salt marsh",
                          `ecosystem_type.Mangrove` = "Mangrove",
                          `ecosystem_type.Coral_reef` = "Seagrass",
                          `ecosystem_type.Seagrass` = "Coral reef"
                        )) %>%
  rename(label = `label name`, F1_ecoType = `F1 - label`) %>%
  mutate(label2 = paste0(label,", F1 = ", signif(F1_ecoType, 2))) 

ecoTypeScoresLabelKey <- ecoTypeScores$label2
names(ecoTypeScoresLabelKey) <- ecoTypeScores$label
  


## 1. Plot figure
fig4_C_simplified <- ggplot()+
  
  # Plot mitigation tiles
  geom_tile(data = mitigationSums %>% filter(0<n_articles & oro_branch == "Mitigation"), 
            aes(y=as.numeric(factor(oro_type)), x=as.numeric(factor(ecosystem_type))+1,fill = bi_class), show.legend = FALSE)+
  # Text of article numbers
  geom_text(data=mitigationSums %>% filter(0<n_articles & oro_branch == "Mitigation"),
            aes(y=as.numeric(factor(oro_type)), x=as.numeric(factor(ecosystem_type))+1,
                label = formatC(n_articles, format="d", big.mark=",")), col="black", size=3)+
  
  # Plot triangles for adaptation outcomes
  geom_polygon(data = humanDf %>% filter(0<n_articles & oro_branch != "Mitigation"), 
               aes(x,y,group=id, fill = bi_class), show.legend = FALSE, col="darkgrey")+
  geom_polygon(data = natureDf%>% filter(0<n_articles & oro_branch != "Mitigation"), 
               aes(x,y,group=id, fill = bi_class), show.legend = FALSE, col="darkgrey")+
  # text of article numbers 
  geom_text(data=rbind(humanDfText, natureDfText)%>% filter(0<n_articles& oro_branch != "Mitigation"), 
            aes(x,y,label = formatC(n_articles, format="d", big.mark = ",")),
            col="black", size=3)+
  
  bi_scale_fill(pal = biPal5, dim=5, na.value = "white")+
  
  geom_hline(yintercept = c(3.5,5.5), col="black", linewidth=1)+

  
  # # Format axes
  scale_x_continuous(breaks = 1:nrow(ecoTypeAES),labels = ecoTypeScoresLabelKey)+
  scale_y_continuous(breaks = 1:nrow(typeAES),labels = stringr::str_wrap(typeAES$label, width=20))+
  # scale_y_binned(breaks = 1:nrow(typeAES),labels = typeAES$label)+ #, limits = c(1,nrow(typeAES))
  # 
  # coord_cartesian(ylim = c(0.5, nrow(typeAES)+0.5), clip = 'off')+
  labs(
    x = "Ecosystem type" 
  )+
  coord_flip()+ # added this -- double check
  theme_bw()+
  theme(
    #plot.margin = unit(c(0,0,0,0), "cm"),
    axis.title.x = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    axis.text.x = element_text(angle=45, vjust=1, hjust=1, size=9),
    axis.text.y = element_text(size=9)
    #axis.title.x = element_text(vjust = -8)
  )



# 2. New bi-legend
biLegend2 <- bi_legend(pal = biPal5,
                    dim = 5,
                    xlab = "% Coastal ecosystem articles",
                    ylab = "Coastal ecosystem % of all",
                    breaks = labs2,
                    arrows=FALSE,
                    size = 9)
biLegend2 <- biLegend2+theme(
  panel.background = element_rect(fill="transparent"),
  plot.background = element_rect(fill='transparent', color=NA))



# 3. Legend showing where outcomes are displayed
outcomeLegendDf <- rbind(
  data.frame(
    outcome = paste("Mitigation"), x= -0.5+c(0,1,1,0),y=-0.5+c(0,0,1,1)
  ),
  data.frame(
    outcome = paste("Human\nadaptation"), x = 1+-0.5+c(0,1,1), y=-0.5+c(0,0,1)
  ),
  data.frame(
    outcome = paste("Natural\nadaptation"), x=1+-0.5+c(0,1,0), y=-0.5+c(0,1,1)
  )
)

outcomeLegendTextDf <- outcomeLegendDf %>%
  group_by(outcome) %>%
  mutate(x = mean(x), y = mean(y))

outcomeLegend <- ggplot()+
  geom_polygon(data=outcomeLegendDf, aes(x=x, y=y, group=outcome),
               fill="transparent", col="black")+
  geom_text(data=outcomeLegendTextDf, aes(x=x, y=y, label = outcome), col="black", size=3)+
  theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank()
    
  )


fig4_C_simplified2 <- ggdraw() +
  draw_plot(fig4_C_simplified+theme(plot.margin = unit(c(1,0.2,6,0), "cm")), 0, 0, 1, 1) +
  draw_plot(biLegend2, x=0, y=0, width=0.4, height=0.4)+
  draw_plot(outcomeLegend+theme(plot.margin = unit(c(0,0,1,0), "cm")), x=0.5, y=0, width=0.45, height=0.3)


fig4_C_simplified2


```

```{r simplify panel C further - no more bivariate colour}
cii_text <- data.frame(
  x=c(nrow(ecoTypeAES)+0.45, nrow(ecoTypeAES)-0.45),
  y=c(0.55,1.45),
  labs = c("Nature", "Human")
)

## Join y axis labels for ecosystem type with model scores
ecoTypeScores <- modelScores[modelScores$model == "ecosystem_type_simplified2",] %>% 
  select(`label name`, `F1 - label`)%>%
  filter(!is.na(`F1 - label`)) %>%
  mutate(`label name` = recode(`label name`,
                          `ecosystem_type.Salt_marsh` = "Salt marsh",
                          `ecosystem_type.Mangrove` = "Mangrove",
                          `ecosystem_type.Coral_reef` = "Seagrass",
                          `ecosystem_type.Seagrass` = "Coral reef"
                        )) %>%
  rename(label = `label name`, F1_ecoType = `F1 - label`) %>%
  mutate(label2 = paste0(label,", F1 = ", signif(F1_ecoType, 2))) 

ecoTypeScoresLabelKey <- ecoTypeScores$label2
names(ecoTypeScoresLabelKey) <- ecoTypeScores$label
  


## 1. Plot figure
fig4_C_simpleColor_i <- ggplot()+
  
  # Plot mitigation tiles
  geom_tile(data = mitigationSums %>% filter(0<n_articles & oro_branch == "Mitigation"), 
            aes(y=as.numeric(factor(oro_type)), x=as.numeric(factor(ecosystem_type))+1, 
                fill = percent_articles))+
  # Text of article numbers
  geom_text(data=mitigationSums %>% filter(0<n_articles & oro_branch == "Mitigation"),
            aes(y=as.numeric(factor(oro_type)), x=as.numeric(factor(ecosystem_type))+1,
                label = formatC(n_articles, format="d", big.mark=",")), col="black", size=3)+
  
  # Plot triangles for adaptation outcomes
  geom_polygon(data = humanDf %>% filter(0<n_articles & oro_branch != "Mitigation"), 
               aes(x,y,group=id, fill = percent_articles), col="darkgrey")+
  geom_polygon(data = natureDf%>% filter(0<n_articles & oro_branch != "Mitigation"), 
               aes(x,y,group=id, fill = percent_articles), col="darkgrey")+
  # text of article numbers 
  geom_text(data=rbind(humanDfText, natureDfText)%>% filter(0<n_articles& oro_branch != "Mitigation"), 
            aes(x,y,label = formatC(n_articles, format="d", big.mark = ",")),
            col="black", size=3)+
  # Colour scale
  scale_fill_binned(name = "% Coastal\necosystem\narticles", 
               type = "gradient", 
               low = RColorBrewer::brewer.pal(5,"Greens")[1], 
               high = RColorBrewer::brewer.pal(5,"Greens")[5],
               breaks = breaksFill, nice.breaks = FALSE,
               labels = function(x) ifelse(1000 <= x, paste(x/1000, "k"), paste(x)),
               rescaler = scales::rescale,
               #values = range01(breaksFill),
               show.limits = TRUE, 
               limits = breaksFill[c(1, length(breaksFill))], 
               oob= scales::squish,
               na.value = "transparent",
               guide = guide_coloursteps(order = 1) #barwidth = unit(0.5, 'cm') 
               )+ 
  
  geom_hline(yintercept = c(3.5,5.5), col="black", linewidth=1)+

  
  # # Format axes
  scale_x_continuous(breaks = 1:nrow(ecoTypeAES),labels = ecoTypeScoresLabelKey)+
  scale_y_continuous(breaks = 1:nrow(typeAES),labels = stringr::str_wrap(typeAES$label, width=20))+
  # scale_y_binned(breaks = 1:nrow(typeAES),labels = typeAES$label)+ #, limits = c(1,nrow(typeAES))
  # 
  # coord_cartesian(ylim = c(0.5, nrow(typeAES)+0.5), clip = 'off')+
  labs(
    x = "Ecosystem type" 
  )+
  coord_flip()+ # added this -- double check
  theme_bw()+
  theme(
    #plot.margin = unit(c(0,0,0,0), "cm"),
    axis.title.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_text(angle=45, vjust=1, hjust=1, size=9),
    axis.text.y = element_text(size=9),
    legend.key.height = unit(0.35, 'cm'),
    legend.key.width = unit(1, 'cm'),
    legend.text = element_text(size=6),
    legend.position = "top"
    #axis.title.x = element_text(vjust = -8)
  )

fig4_C_simpleColor_i


# 3. Legend showing where outcomes are displayed
outcomeLegendDf <- rbind(
  data.frame(
    outcome = paste("Mitigation"), x= -0.5+c(0,1,1,0),y=-0.5+c(0,0,1,1)
  ),
  data.frame(
    outcome = paste("Human\nadaptation"), x = 1+-0.5+c(0,1,1), y=-0.5+c(0,0,1)
  ),
  data.frame(
    outcome = paste("Natural\nadaptation"), x=1+-0.5+c(0,1,0), y=-0.5+c(0,1,1)
  )
)

outcomeLegendTextDf <- outcomeLegendDf %>%
  group_by(outcome) %>%
  mutate(x = mean(x), y = mean(y))

outcomeLegend <- ggplot()+
  geom_polygon(data=outcomeLegendDf, aes(x=x, y=y, group=outcome),
               fill="transparent", col="black")+
  geom_text(data=outcomeLegendTextDf, aes(x=x, y=y, label = outcome), col="black", size=3)+
  theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank()
    
  )


fig4_C_simpleColor <- ggdraw() +
  draw_plot(fig4_C_simpleColor_i+theme(plot.margin = unit(c(0,0.2,6,0), "cm")), 0, 0, 1, 1) +
  draw_plot(outcomeLegend+theme(plot.margin = unit(c(0,0,1,0), "cm")), x=0.6, y=0, width=0.45, height=0.3,
            hjust = 0.5)


fig4_C_simpleColor


```



```{r old plot panel C.i - Mitigation}
fig4_C_i <- ggplot(mitigationSums, aes(y=oro_type, x=ecosystem_type))+
  geom_tile(aes(fill = percent_articles))+
  scale_fill_gradient2(mid="white",high="#3182bd", midpoint = 0, guide = guide_coloursteps())+
  scale_y_discrete(limits=rev)+
  geom_hline(yintercept = c(0.5,2.5,4.5), col="black", linewidth=0.5)+
  annotation_raster(marsh_ras, 0.5, 1.5, -2, -0)+
  annotation_raster(mangrove_ras, 1.5, 2.5, -2, -0)+
  annotation_raster(seagrass_ras, 2.5, 3.5, -2, -0)+
  annotation_raster(coral_ras, 3.5, 4.5, -2, -0)+
  #annotation_raster(macro_ras, 3.5, 4.5, -2, -0)+
  coord_cartesian(ylim = c(-1.5, length(levels(mitigationSums$oro_type))), clip = 'off')+
  labs(
    x = "Ecosystem type", #y = "ORO type", 
    fill = "%\ncoastal ecosystem\narticles",
    title = "i. Mitigation"
  )+
  theme_bw()+
  theme(
    #plot.margin = unit(c(0,0,0,0), "cm"),
    axis.title.y = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    axis.text.x = element_text(angle=45, vjust=1, hjust=1)
    #axis.title.x = element_text(vjust = -8)
  )

fig4_C_i

```




# Write main figure

```{r Write figure to pdf}
pdf(file = here::here("figures/main/marineSystemsAndClimateImpactDrivers.pdf"),
    width = 15, height = 7)
plot_grid(fig4_A_ggp+theme(plot.margin = unit(c(0,0,2,0), "cm")),
          fig4_B_percent_nonlinear_ggp+theme(plot.margin = unit(c(0,0.75,0,0), "cm")), 
          fig4_C_simpleColor + theme(legend.key.width = unit(10, 'in')), #fig4_C_simplified2, #+theme(plot.margin = unit(c(2,0,0,0), "cm"))
          rel_widths = c(0.7,1,1), ncol=3, labels = list("a.","b.","c."), label_size = 19,
          align = "v", axis = "b")
while (!is.null(dev.list())) dev.off()

```

# Interpretation 
## Panel C

For socio-institutional and Built infrastructure and tech:
- salt marshes are associated with human and natural adaptation outcomes, but this signal is weak because they form a very small percentage of articles overall.

For conservation:
- small % of coastal ecosystem articles have mitigation outcomes, largest of these is found in mangroves (7%)
- Salt marshes and mangroves are most studied for human and natural adaptation outcomes, and coral reefs for natural adaptation but not human.

For HA Evolution:
- negligible numbers of articles with mitigation outcomes
- Most articles are focused on natural adaptation outcomes, with a high proportion for coral reefs. The latter also forms a high percent of all articles (68%)

Increase efficiency
- barely associated with coastal ecosystems 

For CO2 removal and storage:
- high proportion of articles with mitigation and natural adaptation outcomes are found in salt marsh, mangrove and (to a lesser extent) seagress ecosystems. These articles also form a high proportion of articles overall. 


Marine renewable energy:
- small proportion of articles associated with coastal ecosystems, but of these most are associated with salt marshes. This could just be an artefact of similar terms bewteen mitigation objectives?


# Supplemental Hovmoller plot of ecosystem type over time


```{r read in data for the plot}

## Access relevant tables
predRel <- tbl(dbcon, "pred_relevance") %>%
  filter(0.5 <= relevance_mean) %>%
  select(analysis_id)

uniquerefs <- tbl(dbcon, "uniquerefs") %>%
  select(analysis_id, year) %>%
  collect() %>%
  mutate(year = as.Date(paste0(year,"-01-01"))) %>% 
  filter(as.Date("1980-01-01") <= year)

predType <- tbl(dbcon, "pred_oro_type_long") %>%
  filter(0.5 <= mean) %>%
  select(analysis_id, oro_branch, oro_type) 


predMarSys <- tbl(dbcon, "pred_marine_system") %>%
  select(analysis_id, 
         `marine_system.land - mean_prediction`,
         `marine_system.coastal ocean - mean_prediction`,
         `marine_system.open-ocean - mean_prediction`) %>% 
  rename(land = `marine_system.land - mean_prediction`,
         coastal_ocean = `marine_system.coastal ocean - mean_prediction`,
         open_ocean = `marine_system.open-ocean - mean_prediction`) %>%
  collect()%>%
  reshape2::melt(id.vars = c("analysis_id"), variable.name = "marine_system", value.name = 'mean') %>%
  filter(0.5 <= mean) %>%
  select(-c(mean))


predEcoType <- tbl(dbcon, "pred_ecosystem_type") %>%
  select(analysis_id,
         `ecosystem_type.Salt_marsh - mean_prediction`, ## ** `ecosystem_type.Salt_marsh - mean_prediction`
         `ecosystem_type.Mangrove - mean_prediction`,
         `ecosystem_type.Coral_reef - mean_prediction`,
         `ecosystem_type.Seagrass - mean_prediction`) %>%
  rename(Salt_marsh = `ecosystem_type.Salt_marsh - mean_prediction`,
         Mangrove = `ecosystem_type.Mangrove - mean_prediction`,
         Coral_reef = `ecosystem_type.Coral_reef - mean_prediction`,
         Seagrass = `ecosystem_type.Seagrass - mean_prediction`) %>%
  collect() %>%
  reshape2::melt(id.vars = c("analysis_id"), variable.name = "ecosystem_type", value.name = 'prediction') %>%
  #filter(0.5 <= mean) %>%
  mutate(relevant = ifelse((ecosystem_type == "Salt_marsh" & 0.5 <= prediction) |
                             (ecosystem_type != "Salt_marsh" & 0.5 <= prediction), 1,0)) %>%
  filter(relevant == 1) %>%
  select(-c(prediction, relevant))



## Retrieve aesthetics for relevant factoring variables
typeAES <- factor_aes[which(factor_aes$variable == "oro_type"),]
typeAES <- typeAES[order(typeAES$order),]
ecoTypeAES <- factor_aes[which(factor_aes$variable == "ecosystem_type"),]
ecoTypeAES <- ecoTypeAES[order(ecoTypeAES$order),]
adaptAES <- factor_aes[which(factor_aes$variable == "adapt_to_threat"),]
adaptAES <- adaptAES[order(adaptAES$order),]
```



```{r Format dataframes and calculate sums by ecosystem type and year}
## Data joining

# Format into data frame where each row is a publication (unique analysis_id)

# Include only articles that have a prediction for ORO type AND coastal marine system and ecosystem type AND year greater or equal to 1980
coastEcoTypeDf <- predRel %>%
  inner_join(uniquerefs, by = "analysis_id", copy=T) %>%
  inner_join(predType, by = "analysis_id", copy = T) %>%
  inner_join(predMarSys, by="analysis_id", copy=T) %>%
  filter(marine_system == "coastal_ocean") %>%
  inner_join(predEcoType, by="analysis_id", copy=T) %>%
  collect()


## Factoring variables for plotting

# use aesthetics to factor variables
coastEcoTypeDf <- coastEcoTypeDf %>%
  mutate(
    oro_type = factor(oro_type, levels = typeAES$level, labels = typeAES$label),
    ecosystem_type = factor(ecosystem_type, levels = ecoTypeAES$level, labels = ecoTypeAES$label)
  )
coastEcoTypeDf$year <- as.Date(coastEcoTypeDf$year,origin = as.Date("1970-01-01"))


# Tabulate counts 
library(tidyr)

coastEcoTypeDfYearSums <- coastEcoTypeDf %>%
  group_by(ecosystem_type, oro_type, year) %>%
  summarise(n = n())

# Bin counts to smooth out really high values
coastEcoTypeDfYearSums <- coastEcoTypeDfYearSums %>%
  mutate(n_bin = cut(n, unique(quantile(coastEcoTypeDfYearSums$n, probs = seq(0, 1, by=0.1))),
                     include.lowest = TRUE))


```

```{r plot number of articles for ecosystem type over time}
require(forcats)
coastEcoTypeDfYearSums <- coastEcoTypeDfYearSums %>%
  mutate(oro_type = fct_recode(oro_type, "Socio-\ninstitutional" = "Socio-institutional"))

ecosystemTypeYear_ggp <- ggplot(coastEcoTypeDfYearSums, aes(x=year, y=ecosystem_type, fill=n_bin))+
  facet_grid(oro_type ~., labeller = label_wrap_gen(width = 15))+
  scale_fill_brewer()+
  geom_tile()+
  scale_x_date(limits = as.Date(c("1980-01-01","2022-12-31")))+
  labs(y = "Ecosystem type", x="Year", fill = "N\nArticles")+
  theme_bw()

ecosystemTypeYear_ggp

ggsave(here::here("figures/supplemental/ecosystemTypeHovmollerPlot.pdf"),
       plot= ecosystemTypeYear_ggp,
       width = 6, height = 8, units = 'in')
```



